
\subsection{Semirings that are not fields}
\label{sec:beyond-fields}
In our discussion so far, a prominent role was played by \kl{weighted automata} over a field. However, \kl{weighted automata} make also sense in a more general setting, where a semiring is used instead of a field. We discuss this more general setting in the present section.

\paragraph*{Weighted automata over a semiring.}
We begin by recalling the definition  of \kl{weighted automaton}  in the case of a semiring which is not necessarily a field. One approach is to use Definition~\ref{def:weighted-automaton}, suitably generalised. Since we are working in a semiring that might no longer be a field, we have to be careful when speaking of \kl{linear map}s in items~\ref{it:weighted-definition-transitions} and~\ref{it:weighted-definition-final} of Definition~\ref{def:weighted-automaton}. The appropriate notion in this case is matrices: for each input letter, the corresponding state transformation is: 
\begin{align*}
q \in \domain^d \quad \mapsto \quad qA \in \domain^d,
\end{align*}
where $q$ is viewed as a row vector and $A$ is a $d \times d$ matrix in the semiring. In the definition, we have to be careful about the order of multiplication, since the semiring might have non-commutative multiplication. In order to be equivalent to a model that will be described below,  we need the new values from the matrix to come after the old values from $q$, hence $qA$ instead of $Aq$.  Similarly, the \kl{final map} is of the form $q \mapsto q b$, where $b$ is a column vector of \kl(protocol){dimension} $d$.

However, for the purposes of this section, it  will be more convenient to work with an alternative presentation of \kl{weighted automata}, which is based on the intuition of nondeterministic automata with weights on states and transitions, as defined below. 
\begin{definition}
    [Weighted automaton, nondeterministic presentation] 
    \label{def:weighted-automaton-nondeterministic}
    A \intro{weighted automaton} consists of a finite input alphabet $\Sigma$,  a finite set of states $Q$, and functions: 
    \begin{align*}
    \myunderbrace{I : Q \to \domain}{initial}
    \quad
    \myunderbrace{F : Q \to \domain}{final}
    \quad
    \myunderbrace{\Delta : Q \times \Gamma \times Q \to \domain}{transitions}.
    \end{align*}
\end{definition}
 A run of this automaton is defined in the usual way: it is a sequence of transitions, one for each input letter, such that consecutive transitions agree on the connecting states. The weight of a run is the product of: (1) the initial weight of its source state; (2) the weights used by its transitions; and (3) the final weight of its target state. If the semiring is non-commutative, the order of multiplication is  important, and transitions are multiplied in the order corresponding to the input string. For an input string, the output of the automaton is the sum of weights of all runs over this automaton (sum is always commutative).  The model from Definition~\ref{def:weighted-automaton-nondeterministic}  defines the same functions as the model from Definition~\ref{def:weighted-automaton}, with the appropriate semiring modifications that were described earlier in this section, see~\cite[Lemma 8.3]{bojanczyk_automata_2025}. For the purposes of this seciton, we use the nondeterministic  model described from Definition~\ref{def:weighted-automaton-nondeterministic}.



  Recall Conjecture~\ref{conj:regular-continuous}, which says that a string-to-string function is \kl(function){regular} if and only if it is \kl{field continuous}. One could consider variants of this conjecture for semirings.  For a class $\algclass$ of semirings, let us define \emph{continuity over $\algclass$} to be the same as in Definition~\ref{def:weighted-continuity}, except that instead of fields, we have semirings from the class $\algclass$. This section is devoted to studying   variants of Conjecture~\ref{conj:regular-continuous} for  important classes of semirings, such as finite fields, all fields,  and all semirings. The relationship between the continuity notions is explained in the following diagram. (The diagram also includes \kl{rational function}s, which are a propert subclass of the \kl{regular function}s that will be discussed in \cref{sec:rational-functions}.) The diagram also highlights in red the three classes of functions that we conjecture to be the same in Conjecture~\ref{conj:regular-continuous}.
implication immediate, it is one-way by Example~\ref{ex:not-regular-but-continuous-over-finite-fields}
\[
\begin{tikzcd}[row sep=small]
 \text{\blue{continuous over all semirings}}
\arrow[d,blue, equal,"\text{\cref{thm:rational-functions}}"]
\\
 \text{\blue{rational string-to-string functions}}
\ar[d,Rightarrow,"\text{ implication is one-way,  see e.g.~\cite[p. 218]{engelfrietMSODefinableString2001}}"]
\\
 \text{\red{regular string-to-string functions}}
% \ar[d,Rightarrow,"\text{ \cref{thm:regular-continuous-commutative-semirings}}"]
\ar[d,red,Rightarrow,"\text{ \cref{lem:from-regular-to-protocol}}"]
\\
% \text{continuous over commutative semirings}
% \downsymbol{\subseteq}{immediate} 
% 
 \text{\red{computed by a protocol}}
\ar[d,red,Rightarrow,"\text{\cref{lem:postcomposition-weighted-automaton}}"]
% \downsymbol{\subseteq}{\cref{thm:regular-continuous-commutative-semirings}}
\\
 \text{\red{continuous over fields}}
\ar[uu, red, bend left=80,Rightarrow,"\text{ Conjecture~\ref{conj:regular-continuous}}"]
\ar[d,Rightarrow,"\text{ implication is one-way, see Example~\ref{ex:not-regular-but-continuous-over-finite-fields}}"]
\\
 \text{continuous over finite fields}
\arrow[d,equal,"\text{\cref{claim:regular-weighted-automata}}"]
\\
 \text{Boolean continuous}
\end{tikzcd}
\]

There are three parts in the diagram, indicated using colours. The upper part, in blue, corresponds to the strongest continuity condition, namely over all semirings. As we explain in Section~\ref{sec:rational-functions}, this condition characterises \kl{rational function}s, a well-known transducer class. The middle part, in red, corresponds to the continuity condition over fields, which is conjectured to characterise \kl{regular function}s. Finally, the lower part, in black, corresponds to the weakest continuity condition, namely over finite fields. As explained in the proof of \cref{thm:evidence-for-the-conjecture}, this condition is the same as \kl{Boolean continuity}, and it is strictly more general than regularity. There is no machine model for the black part, because there are uncountably many such functions, as explained in \cite{bojanczykTitoRegular23}.

Of course, the diagram does not exhaust all possible notions of continuity. For example, we could consider continuity over a single semiring, such as the field $\Rat$ of rationals, or the field $\Rat(x)$. For all we know, even these notions might also characterise the \kl{regular function}s. Another possibility is to consider continuity over all commutative semirings, which is discussed in Section~\ref{sec:commutative-semirings}, and again conjectured to characterise the \kl{regular function}s.

\subsubsection{Rational functions}
\label{sec:rational-functions}
In this section we describe the \kl{rational function}s, and prove that they are exactly the functions which are continuous over all semirings.  We only give a brief description of the class, for a more precise definition the reader is referred to~\cite[Section 14.2]{bojanczyk_automata_2025}. The underlying model is (one-way) nondeterministic automata with output. This is like an \textsc{nfa}, except that there are extra labels for output strings, as  explained in the following picture: 
\mypic{5}
The output of a run is obtained by concatenating the labels, similarly to how it is done in a \kl{weighted automaton} from Definition~\ref{def:weighted-automaton-nondeterministic}. (This similarity will be revisited in a moment.) The semantics of the automaton is a binary relation that maps an input string to all possible outputs of accepting runs. Any string-to-string relation that can be obtained this way is called a \kl{rational string-to-string relation}, see~\cite[Chapter IX]{Eilenberg74}. If the relation is a function, i.e.~for each input string there is exactly one output string, then it is called a \intro{rational string-to-string function}. (We add the ``string-to-string'' qualifier to avoid confusion with the field  of rational functions, which consists of fractions of polynomials.)  

Below we show that: (1) the \kl{rational function}s are a strict subset of the \kl{regular} ones; and (2) they are exactly the functions that are continuous over all semirings. Both results are straightforward and could be called folklore.

\begin{myexample}
    [Rational is weaker than regular]
    For the separation between \kl(function){rational} and \kl(function){regular}, a short argument is given in \cite[p. 218]{engelfrietMSODefinableString2001}. The duplicating function $w \mapsto ww$ is \kl(function){regular}. It cannot be \kl(function){rational} however, since its image is not a \kl{regular language}, while \kl{rational relation}s have \kl{regular} images~\cite[Theorem IX.3.1]{Eilenberg74}.
\end{myexample}





\begin{theorem}\label{thm:rational-functions}
    A string-to-string function is rational if and only if it is continuous over all semirings.
\end{theorem}
\begin{proof}
    The left-to-right implication is proved using a simple product construction, which is particularly easy if we use the nondeterministic presentation of weighted automata from Definition~\ref{def:weighted-automaton-nondeterministic}. The right-to-left implication is proved by viewing a rational string-to-string functions as a special case of weighted automata, for suitable semiring. The semiring is 
    \begin{align*}
    \domain = \pfin(\Gamma^*),
    \end{align*}
    i.e.~finite sets of output strings, with the addition being union and multiplication being concatenation. Essentially by comparing the definitions, one sees that a string-to-string relation is regular if and only if it is computed by a weighted automaton over this semiring. This observation gives us the right-to-left implication in the theorem. Indeed, suppose that a string-to-string function $f : \Sigma^* \to \Gamma^*$ is continuous over all semirings. Consider the weighted automaton 
    \begin{align*}
    \iota : \Gamma^* \to \pfin(\Gamma^*),
    \end{align*}
    which maps a string to itself (as a singleton set). By continuity, we know that $f; \iota$ is computed by a weighted automaton over $\domain$. This means that the composition $f;\iota$ is a rational string-to-string relation; in particular the same is true for $f$. Since the composition is also functional, it follows that $f$ is a rational function. 
\end{proof}


\subsubsection{Commutative semirings}
We finish this section by discussing one more kind of continuity, namely continuity over all commutative semirings. We conjecture that this continuity is also the same as regularity, but we are able to prove only one implication.
\label{sec:commutative-semirings}
\begin{theorem}\label{thm:regular-continuous-commutative-semirings}
    If a string-to-string function is  regular, then it is weighted continuous over commutative semirings.
\end{theorem}
\begin{proof}
    Observe that we have already proved a weaker version of this theorem, namely for field continuity, in \cref{lem:postcomposition-weighted-automaton}. The proof for fields passed through protocols. Unfortunately, we cannot reuse that proof, since we do not know if protocols over a semiring output domain are equivalent to weighted automata. This is because we do not have a strong enough version of the Fliess Theorem for semirings, although some work in that direction has been done~\cite[Corollary 2.15]{daviaud25}. For this reason, we give a direct proof, which does not use protocols. 

        Let $\domain$ be a commutative semiring, and  consider  a composition 
    \[
    \begin{tikzcd}
    \Sigma^* 
    \ar[r,"f"]
    & 
    \Gamma^*
    \ar[r,"g"]
    &
    \domain
    \end{tikzcd}
    \]
    where the first function $f$ is computed by a two-way automaton, and the second function $g$ is computed by a weighted automaton over $\domain$. We need to show that the composition $f;g$ can be computed by a weighted automaton over $\domain$. To prove the lemma, we use a straightforward product construction. To describe the construction, we use \emph{weighted graphs}. Such a graph is a directed graph, where every directed edge has a weight, and every vertex has two weights: an initial and final weight. For an input string $w \in \Sigma^*$, consider the following weighted graph, which call the \emph{run graph}:
    \begin{itemize}
        \item \textbf{Vertices.} Vertices are triples of the form $(p,x,q)$ where $(p,x)$ is a configuration of the two-way automaton for $f$ and  $q$ is a state of the weighted automaton for $g$. Recall that a configuration of the two-way automaton consists of a state $p$, and a position  $x$  in the string obtained from $w$ by adding endmarkers $\vdash$ and $\dashv$ to both ends. 
        \item \textbf{Edges.} In the graph, there is an edge 
        \begin{align*}
        (p,x,q) \xrightarrow{a} (p',x',q')
        \end{align*}
        if the two-way automaton has a single transition which goes from configuration $(p,x)$ to configuration $(p',x')$.
        \item \textbf{Weights of edges.} Consider an edge as in the previous item. The weight of this edge is defined as follows. Let $u$ be the output string, possibly empty, which is produced by the two-way automaton in the transition that goes from $(p,x)$ to $(p',x')$. The weight of the edge is defined to be the  sum of weights of all runs in the weighted automaton that go from $q$ to $q'$ and have input string $u$. In the special case when $u$ is empty, this will mean that $a$ is the $1$ of the semiring, i.e.~the neutral element of multiplication, because there is a unique run over the input string, and this run has weight $1$. 
        \item \textbf{Initial weights of vertices.} The initial weight of a vertex $(p,x,q)$ is zero if $(p,x)$ is not the initial configuration of the two-way automaton, and otherwise it is the initial weight of  the state $q$.
        \item \textbf{Final weights of vertices.} The final weight of a vertex $(p,x,q)$ is zero if $(p,x)$ is not the final configuration of the two-way automaton, and otherwise it is the final weight of the state $q$.
    \end{itemize}
The weight of a path in this graph is defined to be the product of: (1) the initial weight of the first vertex; (2) the weights of all edges on the path; and (3) the final wight of the last vertex. It is  easy to see that for an input string $w \in \Sigma^*$, the output of the composition $f;g$ is the same as the sum of weights of all paths in the corresponding run graph.  (This sum finite and therefore well-defined, since the run graph has finitely many paths by virtue of being  acyclic. This is because the two-way automaton is not allowed to loop.) To complete the proof of the theorem, it is enough to show the following claim.
\begin{claim}
    There is a weighted automaton which inputs a string $w \in \Sigma^*$, and outputs the sum of weights of all paths in the corresponding run graph.
\end{claim}
\begin{proof}
    This claim is the place where we use commutativity of the semiring. Consider a run graph, as in the following picture (to avoid clutter, we only show the vertices, and not the weights):
    \mypic{3}
    Consider a path in the run graph. Since the run graph is necessarily acyclic, such a path is uniquely described by the set of edges that it uses, as in the   following picture:  
    \mypic{4}
    A run graph together with a distinguished path can be viewed as a string, which we call its \emph{string representation}. Each letter in the string representation describes a single column of the picture above. (The string representation includes the weights of the vertices and edges, which are omitted in the picture.)     The function which inputs a string from $\Sigma^*$ and returns the set of all string representations of paths in the corresponding run graph is easily seen to be a rational string-to-string relation. Let this relation be 
    \begin{align*}
    R \subseteq \Sigma^* \times \Delta^*,
    \end{align*}
    where $\Delta$ is the alphabet used for string representation of paths inside run graphs. The function in the present claim is the same as 
    \begin{align*}
    w \in \Sigma^* 
    \quad \mapsto \quad 
    \sum_{\substack{v \in \Delta^* \\ (w,v) \in R}} \text{weight of path described by $v$}.
    \end{align*} 
    Weighted automata are closed under sums as above~\cite[Lemma 8.12]{bojanczyk_automata_2025}, and therefore to complete the proof of the claim it is enough to show a weighted automaton for the function
    \begin{align*}
    v \in \Delta^* 
    \quad \mapsto \quad 
    \text{weight of path described by $v$}.
    \end{align*}
    This weighted automaton is trivial: it simply mutiplies the weights of all highlighted edges, together with the initial weight of the first vertex and the final weight of the last vertex. Here, commutativity of the semiring is crucial, since the multiplication will be done in a left-to-right fashion, which will typically be inconsistent with the order of vertices on the path. 
\end{proof}

\end{proof}

We finish this section by discussing the relationship between two implications, both of which we conjecture to be true.
\begin{align}
\text{weighted continuous over fields}
& \iff
\text{regular}
\label{eq:weighted-continuous-fields-again}\\
    \text{weighted continuous over commutative semirings}
& \iff
\text{regular}
\label{eq:weighted-continuous-commutative-semirings-again}
\end{align}
Since the implications $\impliedby$ are known to be true by \cref{thm:regular-continuous-commutative-semirings}, the more difficult equivalence is the first one, which has a weaker condition on the left side. 
For all we know, only the harder  first equivalence has any bearing on protocols, since we have established continuity for protocols only in the field case, see \cref{lem:postcomposition-weighted-automaton}. Even though it might not be connected to protocols, the  easier second equivalence would still be interesting on its own, as a characterisation of the regular string-to-string functions.