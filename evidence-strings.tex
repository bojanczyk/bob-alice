% LTeX: language=en
\subsection{Evidence for the conjecture}
\label{sec:continuity}
\AP
In this subsection, we show that the \kl{string-to-string functions} computed by
\kl{protocols} share some  good properties of \kl{regular functions}, such as linear size
outputs and computability. Even computability is not a priori obvious, due to
the non-uniformity of the protocols. These results can be seen as evidence of
the open implication 
\begin{align*}
\text{protocol} \implies \text{regular}
\end{align*}
in the conjecture. To prove these results, we will leverage the results on
\kl{weighted automata} from Section~\ref{sec:field-domain}. The point of
departure is the following lemma, which connects \kl{weighted automata} and
\kl{string-to-string functions} that can be computed in our protocol.

    \begin{lemma}
        \label{lem:postcomposition-weighted-automaton}
        Let $\domain$ be a semiring, and consider two functions
        \[
        \begin{tikzcd}
        \Sigma^* 
        \ar[r,"f"]
        &
        \Gamma^*
        \ar[r,"g"]
        & 
        \domain,
        \end{tikzcd}
        \]
        such that $f$ is computed by a \kl{protocol} (with string outputs) and $g$ is computed by a \kl{weighted automaton}, then the composition  $f;g$ is computed by a protocol (with outputs in $\domain$).
    \end{lemma}
    \begin{proof}
      For each string in $\Gamma^*$, the \kl{weighted automaton} for $g$ has an
      associated matrix over the semiring $\domain$, as explained in the proof at the beginning of Section~\ref{sec:proof-of-thm-field-domain}.
      \omc{Here I changed "matrix over the field" to "matrix over the semiring", since we are in a more general setting now.}
      Similarly to that proof, we can modify the protocol for $f$ to a protocol for $f;g$ where the parties send matrices instead of strings. 
    \end{proof}

\begin{corollary}\label{cor:protocol-field-continuity}
    If the domain $\domain$ is a field, then the conclusion of \cref{lem:postcomposition-weighted-automaton} can be strengthened to say that $f;g$ is computed by a weighted automaton.
\end{corollary}
\begin{proof}
    For field outputs, protocols are equivalent to weighted automata, thanks to \cref{thm:field-domain}.
\end{proof}
The above corollary establishes a property of $f$, namely that \kl{weighted automata}
(over a field) are closed under precomposition with $f$. We think that this is
an important property, and therefore we give it a name.

\begin{definition}[Field continuity]
    \label{def:weighted-continuity}
    \AP
    A \kl{string-to-string function} $f : \Sigma^* \to \Gamma^*$ is called
    \intro{field continuous} if functions computed by weighted automata over a
    field are closed under precomposition with $f$.
\end{definition}

The name ``continuous'' is inspired by a
similar terminology that is used in automata theory for functions that preserve
regularity under inverse images, see~\cite[Theorem 4.1]{PinSilva05}
or~\cite[Footnote 2]{continuity20}. For the latter notion, we use the name
\emph{Boolean continuity}.

\begin{definition}[Boolean continuity]
  \AP
  A \kl{string-to-string function} $f : \Sigma^* \to \Gamma^*$ is called
  \intro{Boolean continuous} if preimages of \kl{regular languages} are \kl[regular language]{regular}.
\end{definition}

As we have shown in \cref{cor:protocol-field-continuity}, all
\kl{string-to-string functions} computed by \kl{protocols} are \kl{field continuous}. In
particular, since every \kl{regular string-to-string function} is computed by a
\kl{protocol}, it follows that every regular string-to-string function is field
continuous\footnote{To the best of our knowledge, this is a new result. It can
also be proved directly, without passing through protocols.}. We
conjecture that the converse is also true.

\begin{conjecture}\label{conj:regular-continuous}
  A \kl{string-to-string function} is \kl{field continuous} if and only if it is 
  \kl[regular function]{regular}.
\end{conjecture}

In Example~\ref{ex:quadratic-counterexample} later in this section,  we show that the conjecture becomes false if the
left side is relaxed from \kl{field continuous} to \kl{Boolean continuous}.

Conjecture~\ref{conj:regular-continuous} can be seen as a machine independent
characterisation of the \kl{regular string-to-string functions}. This would be
a very valuable contribution. Almost all known characterisations of the
\kl{regular string-to-string functions} have somewhat lengthy definitions,
based on specific computational models, and it is something of a miracle that
all of these models are equivalent. A possible exception is the
characterisation in~\cite{bojanczykTitoRegular23}, which does not use a machine
model; however that characterisation uses the abstract language of category
theory, and is less elementary than the one in
Conjecture~\ref{conj:regular-continuous}.

As in Conjecture~\ref{conj:protocol-regular-string-to-string}, the content of Conjecture~\ref{conj:regular-continuous} is the left-to-right implication
\begin{align*}
\text{field continuous} \implies \text{regular}.
\end{align*}
Conjecture~\ref{conj:regular-continuous} is stronger than Conjecture~\ref{conj:protocol-regular-string-to-string}, as explained in the following diagram, which shows the known relations between three kinds of string-to-string functions:
\[
\begin{tikzcd}
\text{~~~~regular~~~~}
\ar[d,Rightarrow,shift right=2, "\text{\cref{lem:from-regular-to-protocol}}"']
\\
\text{computed by protocols}
\ar[d,Rightarrow, shift right=2, "\text{\cref{lem:postcomposition-weighted-automaton}}"']
\ar[u,Rightarrow, shift right=2,"\text{Conjecture~\ref{conj:protocol-regular-string-to-string}}"']
\\ 
\text{field continuous} 
\ar[uu,bend right=89, Rightarrow, shift right=2,"\text{Conjecture~\ref{conj:regular-continuous}}"']
\end{tikzcd}
\]


The following theorem gives some evidence for the stronger conjecture,  and
therefore also the weaker one, by showing that the field continuous functions
share some well-known properties of the regular string-to-string functions. 

\evidencefortheconjecture*



% Before proving the theorem, let us comment on the properties that are listed in it.  By Lemma~\ref{lem:from-regular-to-protocol}, every regular string-to-string  function is computed by a protcol, and therefore every regular string-to-string function has the properties that are listed in the theorem. The fact the regular string-to-string functions have the  first three properties is a folklore result and can be seen directly from the definition of regular string-to-string functions, without protocols. (For the third property, it is useful to know that, as language acceptors, two-way automata recognise exactly the regular languages~\cite[Theorem 2]{shepherdson1959reduction}).
% The fact that regular functions have the  property, about postcomposition with weighted automata over a field, is not known in the literature, to the best of our knowledge. A direct proof is possible, 

\begin{proof}
    For properties~\ref{it:linear-size-outputs}
    and~\ref{it:linear-time-computable}, we embed strings into numbers. An
    output string over alphabet $\Gamma$ can be seen as a number in base
    $|\Gamma|$. To avoid the ambiguity that could result from leading zeros, we
    first prepend the string with the digit 1. Let 
    \begin{align*}
    g : \Gamma^* \to \Nat \subseteq \Rat
    \end{align*} 
    be the corresponding encoding. This encoding can be computed by a \kl{weighted
    automaton} over the field $\Rat$, see~\cite[Lemma 8.10]{bojanczyk_automata_2025}.
    By the assumption on \kl{field continuity}, the
    composition $f;g$ can be computed by a \kl{weighted automaton}. This is a
    \kl{weighted automaton} that works in the field of rationals $\Rat$, but  only
    produces natural numbers on its output. By~\cite[p.
    110]{BerstelReutenauer08} the automaton can be chosen so that it only uses
    integers $\Int$, possibly including negative integers. Summing up, we have
    a \kl{weighted automaton} over $\Int$ that outputs the representation, in base
    $|\Gamma|$, of the output string produced by $g$. We claim that for such an
    automaton, the output number
    \begin{enumerate}
        \item has a linear number of digits;
        \item can be computed in linear time.
    \end{enumerate}
    These two claims yield the corresponding items in the statement of the
    theorem. The first item, about a linear number of digits, is true because
    it is true for every \kl{weighted automaton} over $\Int$. This is because
    applying a fixed linear map can only add a constant number of digits, and therefore each input letter can increase the output by a constant number of digits. For the second item, use the fact that a weighted automaton can be evaluated in linear time. We did not find this result in the literature, so we give a proof sketch below.

    \begin{claim}
        Fix a function $f : \Sigma^* \to \Int$ computed by a weighted automaton over $\Int$. Then $f$ can be computed in linear time (ignoring logarithmic factors).
    \end{claim}
    \begin{proof}
        We use the \textsc{ram} model of computation.  In this model, numbers with $n$ digits can be multiplied in time linear in $n$ (ignoring logarithmic factors), using Fast Fourier Transform~\cite[p.291]{schonhage1971schnelle}. If we would try to evaluate the weighted automaton naively, from left to right, we would be doing a linear number of multiplications, involving numbers with a linear number of bits. This would give a quadratic time algorithm. To get linear time, we use  divide and conquer approach which was suggested to us by Marek Soko{\l}owski, and which is inspired by similar algorithms for multipoint evaluation of polynomials~\cite[Section 10.1]{von2003modern}.

        For each input letter, the weighted automaton has an associated matrix. Therefore, the essence of the  problem is to compute the multiplication of $n$ matrices 
        \begin{align*}
        A_1 \cdots A_n,
        \end{align*}
        which are taken from some fixed finite set of square matrices of same dimension. As we have already remarked before, each entry in the resulting matrix has a linear number of bits. Instead of multiplying the matrices from left to right, we organise the multiplication in a balanced binary tree, and evaluate this tree bottom-up. At the bottom of this tree, we have $n/2$ multiplications of matrices from the finite set. More generally, at distance $h$ from the leaves, we have $n  / 2^h$ multiplications of matrices, with the entries in these matrices having $O(2^h)$ bits.  Therefore, the number of multiplications cancels out with the number of digits, and so for every choice of $h$, all multiplications at level $h$ can be performed in linear time, ignoring logarithmic factors. Since the number of levels is  logarithmic, we get the desired result.
    \end{proof}
    
    \omc{I wanted to remove the whole proof of the claim, and change linear time to polynomial time, but I am not "The boss" here. So I will give an honest comment instead (hope you don't ignore it like lots of my comments) : The proof of the claim is a bit technical, and I think it is not very important for the main flow of the paper. Also this is last minute addition; we were supposed to evaluate it more carefully in our tuesday sesions. Also I agree that I am a "noob researcher" but I don't think having "ignoring logarithmic factors" in the statement of the theorem is a good idea. It is like you are forcing the reader to read the proof of the claim to understand what you mean by linear time. So I think for the sake of clarity and simplicity, we should get rid of the proof of the claim, and change linear time to polynomial time in the statement of the theorem.}

    We are left with property~\ref{it:regular-preimages}, about \kl{Boolean
    continuity}. This will follow from the special case of \kl{field continuity},
    where the field is the two-element field.  This is because of  the
    following  folklore correspondence between regular languages and weighted
    automata over the two-element field. 
        
        \begin{claim}\label{claim:regular-weighted-automata}
            A language $L \subseteq \Gamma^*$ is regular iff its characteristic
            function $\Gamma^* \to \set{0,1}$ is computed by a \kl{weighted
            automaton} over the two-element field 
        \end{claim}
        \begin{proof}
            For the left-to-right implication, we observe that a weighted
            automaton over a finite field can be simulated by a deterministic
            finite automaton. For the other direction, we observe that a
            weighted automaton can count the parity of  the number of runs in a
            finite automaton, and if the automaton is deterministic then the
            number of runs is either zero or one, and thus the parity gives the
            right answer.
        \end{proof}

        In terms of the correspondence from the above claim, preimages of
        regular languages become precompositions of \kl{weighted automata} over the
        two-element field. In particular, regularity is preserved. 
\end{proof}

One could think that already the three properties in the above theorem are not
only necessary for regularity, but also sufficient. This is not the case, as
shown by the following example.

\begin{myexample}[Factorials]
    \label{ex:not-regular-but-continuous-over-finite-fields}
    Consider a \kl{string-to-string function}
    \begin{align*}
    g : \Sigma^* \to \set{a}^*
    \end{align*}
    where both the input and output alphabets are unary. A sufficient condition 
    for \kl{Boolean continuity} of such functions is given in~\cite[Example 2.12]{bojanczykTitoRegular23},
    using \emph{factorials}, i.e.~numbers in the set $\setbuild{n!}{$n \in \Nat$}$. 
    This sufficient condition is that: 
    (a) every output string arises from finitely many inputs; and
    (b) every output string has length that is a factorial. 

    It is not hard to come up with a non-regular function that has properties
    (a) and (b), thus ensuring \kl{Boolean continuity}, and which has furthermore
    linear size outputs and is computable in linear time. For example, the
    function could map an input string $w$ to the longest string of factorial
    length that is shorter than $w$. 
\end{myexample}
